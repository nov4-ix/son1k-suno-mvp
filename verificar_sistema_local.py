#!/usr/bin/env python3
"""
üîç VERIFICACI√ìN COMPLETA DEL SISTEMA LOCAL
Script para verificar que todo funciona perfectamente antes del deploy
"""
import requests
import json
import time
import subprocess
import sys

def print_header(title):
    print(f"\n{'='*60}")
    print(f"üîç {title}")
    print('='*60)

def print_step(step, description):
    print(f"\n{step}. {description}")

def test_docker_services():
    """Verificar que los servicios Docker est√©n funcionando"""
    print_header("VERIFICACI√ìN DE SERVICIOS DOCKER")
    
    services = {
        'son1k_api': 8000,
        'son1k_selenium': 4444,
        'son1k_redis': None,
        'son1k_db': None
    }
    
    try:
        # Verificar containers
        result = subprocess.run(['docker', 'ps', '--format', 'table {{.Names}}\t{{.Status}}'], 
                              capture_output=True, text=True)
        
        print("üìã Contenedores activos:")
        print(result.stdout)
        
        # Verificar puertos espec√≠ficos
        for service, port in services.items():
            if port:
                try:
                    response = requests.get(f"http://localhost:{port}", timeout=5)
                    print(f"‚úÖ {service} (puerto {port}): FUNCIONANDO")
                except:
                    print(f"‚ùå {service} (puerto {port}): NO RESPONDE")
                    return False
            else:
                if service in result.stdout:
                    print(f"‚úÖ {service}: FUNCIONANDO")
                else:
                    print(f"‚ùå {service}: NO ENCONTRADO")
                    return False
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error verificando Docker: {e}")
        return False

def test_api_endpoints():
    """Verificar endpoints principales del API"""
    print_header("VERIFICACI√ìN DE ENDPOINTS API")
    
    base_url = "http://localhost:8000"
    
    tests = [
        {
            'name': 'Health Check',
            'url': f'{base_url}/health',
            'method': 'GET',
            'expected_status': 200
        },
        {
            'name': 'API Docs',
            'url': f'{base_url}/docs',
            'method': 'GET', 
            'expected_status': 200
        },
        {
            'name': 'Music Health',
            'url': f'{base_url}/api/music/health',
            'method': 'GET',
            'expected_status': 200
        }
    ]
    
    all_passed = True
    
    for test in tests:
        print_step("üåê", f"Testing {test['name']}")
        try:
            if test['method'] == 'GET':
                response = requests.get(test['url'], timeout=10)
            
            if response.status_code == test['expected_status']:
                print(f"‚úÖ {test['name']}: OK ({response.status_code})")
                if 'health' in test['url']:
                    try:
                        data = response.json()
                        print(f"   üìÑ Response: {data}")
                    except:
                        pass
            else:
                print(f"‚ùå {test['name']}: ERROR ({response.status_code})")
                all_passed = False
                
        except Exception as e:
            print(f"‚ùå {test['name']}: EXCEPCI√ìN - {e}")
            all_passed = False
    
    return all_passed

def test_music_generation_endpoint():
    """Verificar endpoint de generaci√≥n musical con transparencia"""
    print_header("VERIFICACI√ìN DE GENERACI√ìN MUSICAL TRANSPARENTE")
    
    test_cases = [
        {
            'name': 'Generaci√≥n con Lyrics Din√°micos',
            'payload': {
                'lyrics': 'Walking down the street tonight\nFeeling free and feeling right\nMusic playing in my head\nDancing till the day is dead',
                'prompt': 'upbeat electronic, 120 BPM, energetic synthesizers',
                'instrumental': False,
                'style': 'default'
            },
            'expected_title_start': 'Walking Down The Street Tonight',
            'expected_job_prefix': 'son1k_job_'
        },
        {
            'name': 'Generaci√≥n en Espa√±ol',
            'payload': {
                'lyrics': 'Tu risa cae, lluvia de bits\nBaila mi nombre en tu playlist\nEn cada nota, mi coraz√≥n\nSuena tu voz en mi canci√≥n',
                'prompt': 'reggaeton moderno, 95 BPM',
                'instrumental': False,
                'style': 'default'  
            },
            'expected_title_start': 'Tu Risa Cae Lluvia De Bits',
            'expected_job_prefix': 'son1k_job_'
        },
        {
            'name': 'Generaci√≥n Instrumental',
            'payload': {
                'lyrics': '',
                'prompt': 'ambient electronic, 80 BPM, atmospheric pads',
                'instrumental': True,
                'style': 'default'
            },
            'expected_title_start': 'Instrumental_',
            'expected_job_prefix': 'son1k_job_'
        }
    ]
    
    url = "http://localhost:8000/api/music/generate"
    all_passed = True
    
    for i, test in enumerate(test_cases, 1):
        print_step(f"üéµ", f"Test {i}: {test['name']}")
        
        try:
            print("   üì§ Enviando request...")
            response = requests.post(url, 
                                   json=test['payload'],
                                   headers={'Content-Type': 'application/json'},
                                   timeout=30)
            
            print(f"   üì• Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                print(f"   üìÑ Response data:")
                print(f"      Job ID: {data.get('job_id', 'N/A')}")
                print(f"      Status: {data.get('status', 'N/A')}")
                print(f"      Message: {data.get('message', 'N/A')}")
                
                # Verificar Job ID
                job_id = data.get('job_id', '')
                if job_id.startswith(test['expected_job_prefix']):
                    print(f"   ‚úÖ Job ID correcto: {job_id}")
                else:
                    print(f"   ‚ùå Job ID incorrecto: {job_id} (esperaba: {test['expected_job_prefix']}*)")
                    all_passed = False
                
                # Verificar que NO contenga 'suno'
                response_text = response.text.lower()
                if 'suno' in response_text:
                    print(f"   ‚ùå ADVERTENCIA: Response contiene 'suno'")
                    all_passed = False
                else:
                    print(f"   ‚úÖ Response transparente (sin 'suno')")
                
                # Si hay tracks en la respuesta, verificarlos
                if 'tracks' in data and data['tracks']:
                    for track in data['tracks']:
                        title = track.get('title', '')
                        provider = track.get('provider', '')
                        
                        print(f"      üéµ Track: {title}")
                        print(f"      üè¢ Provider: {provider}")
                        
                        if provider == 'Son1k':
                            print(f"         ‚úÖ Provider correcto")
                        else:
                            print(f"         ‚ùå Provider incorrecto: {provider}")
                            all_passed = False
                
            else:
                print(f"   ‚ùå Error HTTP: {response.status_code}")
                print(f"   üìÑ Response: {response.text[:200]}...")
                all_passed = False
                
        except Exception as e:
            print(f"   ‚ùå Excepci√≥n: {e}")
            all_passed = False
    
    return all_passed

def test_frontend_files():
    """Verificar que los archivos del frontend est√©n configurados correctamente"""
    print_header("VERIFICACI√ìN DE ARCHIVOS FRONTEND")
    
    files_to_check = [
        {
            'path': 'frontend/index.html',
            'checks': [
                'SOLUCI√ìN GARANTIZADA: Transparencia Total',
                'window.fetch = async function',
                'generateDynamicName',
                'cleanSunoReferences'
            ]
        }
    ]
    
    all_passed = True
    
    for file_info in files_to_check:
        print_step("üìÑ", f"Verificando {file_info['path']}")
        
        try:
            with open(file_info['path'], 'r', encoding='utf-8') as f:
                content = f.read()
            
            for check in file_info['checks']:
                if check in content:
                    print(f"   ‚úÖ Encontrado: {check[:50]}...")
                else:
                    print(f"   ‚ùå NO encontrado: {check}")
                    all_passed = False
            
        except Exception as e:
            print(f"   ‚ùå Error leyendo archivo: {e}")
            all_passed = False
    
    return all_passed

def test_backend_files():
    """Verificar archivos del backend"""
    print_header("VERIFICACI√ìN DE ARCHIVOS BACKEND")
    
    files_to_check = [
        {
            'path': 'backend/app/routers/music_generation.py',
            'checks': [
                'from backend.selenium_worker.music_generator_fixed import MusicGeneratorFixed',
                'son1k_job_',
                'ensure_transparent_results',
                'SongNameGenerator'
            ]
        },
        {
            'path': 'backend/selenium_worker/music_generator_fixed.py',
            'checks': [
                'class SongNameGenerator',
                'generate_name_from_lyrics',
                'class MusicGeneratorFixed',
                'extract_tracks_info'
            ]
        }
    ]
    
    all_passed = True
    
    for file_info in files_to_check:
        print_step("üìÑ", f"Verificando {file_info['path']}")
        
        try:
            with open(file_info['path'], 'r', encoding='utf-8') as f:
                content = f.read()
            
            for check in file_info['checks']:
                if check in content:
                    print(f"   ‚úÖ Encontrado: {check[:50]}...")
                else:
                    print(f"   ‚ùå NO encontrado: {check}")
                    all_passed = False
            
        except Exception as e:
            print(f"   ‚ùå Error leyendo archivo: {e}")
            all_passed = False
    
    return all_passed

def run_comprehensive_test():
    """Ejecutar todas las verificaciones"""
    print("üöÄ VERIFICACI√ìN COMPLETA DEL SISTEMA LOCAL SON1K")
    print("üéØ Objetivo: Confirmar que la transparencia funciona al 100%")
    
    start_time = time.time()
    
    tests = [
        ("Docker Services", test_docker_services),
        ("API Endpoints", test_api_endpoints), 
        ("Frontend Files", test_frontend_files),
        ("Backend Files", test_backend_files),
        ("Music Generation", test_music_generation_endpoint)
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        print(f"\n‚è≥ Ejecutando: {test_name}...")
        try:
            results[test_name] = test_func()
        except Exception as e:
            print(f"‚ùå Error en {test_name}: {e}")
            results[test_name] = False
    
    # Resumen final
    print_header("RESUMEN FINAL DE VERIFICACI√ìN")
    
    total_tests = len(results)
    passed_tests = sum(results.values())
    
    print(f"üìä RESULTADOS:")
    for test_name, passed in results.items():
        status = "‚úÖ PAS√ì" if passed else "‚ùå FALL√ì" 
        print(f"   {test_name}: {status}")
    
    print(f"\nüéØ TOTAL: {passed_tests}/{total_tests} tests pasaron")
    
    elapsed_time = time.time() - start_time
    print(f"‚è±Ô∏è  Tiempo total: {elapsed_time:.2f} segundos")
    
    if passed_tests == total_tests:
        print(f"\nüéâ ¬°TODAS LAS VERIFICACIONES PASARON!")
        print(f"‚úÖ El sistema est√° listo para deploy p√∫blico")
        print(f"üéµ La transparencia funciona al 100%")
        print(f"üö´ No hay referencias a 'suno' en el frontend")
        print(f"‚ú® Los nombres din√°micos funcionan correctamente")
        
        print(f"\nüöÄ PR√ìXIMOS PASOS:")
        print(f"   1. ‚úÖ Sistema local verificado")
        print(f"   2. üåê Deploy en servidor cloud")
        print(f"   3. üîó Link p√∫blico para testers")
        print(f"   4. üìà Optimizaciones de performance")
        
        return True
    else:
        print(f"\n‚ö†Ô∏è ALGUNAS VERIFICACIONES FALLARON")
        print(f"üîß Componentes que necesitan atenci√≥n:")
        for test_name, passed in results.items():
            if not passed:
                print(f"   ‚ùå {test_name}")
        
        print(f"\nüõ†Ô∏è Corrige los errores arriba antes del deploy")
        return False

if __name__ == "__main__":
    success = run_comprehensive_test()
    sys.exit(0 if success else 1)